<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Manager - <%= company.name %></title>
  <link rel="stylesheet" href="/css/index.css">
  <link rel="stylesheet" href="/css/job.css">
</head>

<body style="
  background: <%= company ? 'linear-gradient(180deg, ' + company.pColor + ', ' + company.sColor + ')' : 'transparent' %>;
  color: <%= company.bpColor %>;
  --pColor: <%= company.pColor %>;
  --sColor: <%= company.sColor %>;
  --bpColor: <%= company.bpColor %>;
  --bsColor: <%= company.bsColor %>;
">
  <main class="jobs-container">
    <div class="nav-row">
      <button class="small-btn" onclick="location.href='/companies'">All companies</button>
      <button class="small-btn" onclick="location.href='/'">Home</button>
      <button class="small-btn" onclick="location.href='/job/<%= encodeURIComponent(company.name) %>'">Job Page</button>
      <button class="small-btn" onclick="location.href='/jobPosts/<%= encodeURIComponent(company.name) %>'">Post a Job</button>
    </div>

    <div class="jobs-header">
      <h1>Manage Jobs: <%= company ? company.name : 'Not found' %></h1>
    </div>

    <div class="jobs-columns">
      <!-- Available Jobs Column -->
      <section class="jobs-column">
        <h2>Available</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => !job.employee_id && !job.has_applications).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta available">Available</div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No available jobs</p>
          <% } %>
        </div>
      </section>

      <!-- Applied For Column -->
      <section class="jobs-column">
        <h2>Applied For</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.has_applications && !job.employee_id).forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  <%= job.applicants_count %> applicant(s)
                  <% if (job.applicants && job.applicants.length > 0) { %>
                    <ul>
                      <% job.applicants.forEach(applicant => { %>
                        <li>
                          <%= applicant.name %>
                          <form action="/jobManager/accept" method="POST" style="display:inline;" onsubmit="return confirm('Accept this applicant for the job?');">
                            <input type="hidden" name="jobId" value="<%= job.id %>">
                            <input type="hidden" name="applicantId" value="<%= applicant.fb_id %>">
                            <button type="submit" class="accept">Accept</button>
                          </form>
                        </li>
                      <% }) %>
                    </ul>
                  <% } %>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No applications yet</p>
          <% } %>
        </div>
      </section>

      <!-- In Progress Column -->
      <section class="jobs-column">
        <h2>In Progress</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.employee_id && job.status !== 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta taken">
                  Assigned to <%= job.employee_name %>
                  <button class="complete-button" 
                          data-job-id="<%= job.id %>"
                          data-employee-id="<%= job.employee_id %>"
                          data-pay="<%= job.pay %>"
                          data-title="<%= job.title %>">
                    Mark As Complete
                  </button>
                </div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No jobs in progress</p>
          <% } %>
        </div>
      </section>

      <!-- Completed Jobs Column -->
      <section class="jobs-column">
        <h2>Completed</h2>
        <div class="jobs-scroll">
          <% if (jobs && jobs.length > 0) { %>
            <% jobs.filter(job => job.status === 'completed').forEach(function(job){ %>
              <article class="job-card">
                <div class="job-title"><b><%= job.title %></b></div>
                <div class="job-desc"><%= job.description %></div>
                <div class="job-pay">Pay: <%= job.pay %></div>
                <div class="job-meta completed">Completed by <%= job.employee_name %></div>
              </article>
            <% }) %>
          <% } else { %>
            <p>No completed jobs</p>
          <% } %>
        </div>
      </section>
    </div>
  </main>

  <!-- PIN Popup for Mark As Complete -->
  <div id="custom-popup" class="popup-overlay">
    <div class="popup-content">
      <button class="close-btn">&times;</button>
      <h2>Enter PIN to Complete Job</h2>
      <form id="popup-form">
        <input type="password" id="pin" name="pin" placeholder="Enter your PIN" required>
        <button type="submit">Confirm</button>
      </form>
    </div>
  </div>

  <script>
    // Only handle the PIN popup for Mark As Complete
    (function () {
      const popup = document.getElementById('custom-popup');
      if (!popup) { console.warn('JobManager: PIN popup element not found'); return; }
      const closeBtn = popup.querySelector('.close-btn');
      const popupForm = document.getElementById('popup-form');
      
      let currentJobId = null;
      let currentEmployeeId = null;
      let currentPay = null;
      let currentTitle = null;

      // Handle "Mark As Complete" button clicks using event delegation
      document.addEventListener('click', function (ev) {
        const btn = ev.target.closest && ev.target.closest('.complete-button');
        if (!btn) return;
        ev.preventDefault();
        try {
          currentJobId = btn.getAttribute('data-job-id');
          currentEmployeeId = btn.getAttribute('data-employee-id');
          currentPay = btn.getAttribute('data-pay');
          currentTitle = btn.getAttribute('data-title');
          console.log('JobManager: opening PIN popup for job', currentJobId, { employee: currentEmployeeId, pay: currentPay });
          // show popup and focus pin input
          popup.style.display = 'flex';
          const pinEl = document.getElementById('pin');
          if (pinEl) { pinEl.value = ''; setTimeout(() => pinEl.focus(), 30); }
        } catch (err) {
          console.error('JobManager: error opening popup', err);
        }
      });

      // Close popup
      if (closeBtn) closeBtn.addEventListener('click', function () {
        popup.style.display = 'none';
        if (popupForm) popupForm.reset();
      });

      popup.addEventListener('click', function (e) {
        if (e.target === popup) {
          popup.style.display = 'none';
          if (popupForm) popupForm.reset();
        }
      });

      if (!popupForm) { console.warn('JobManager: popup form not found'); return; }

      // Handle form submission: call server transfer endpoint with PIN, then reload on success
      popupForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const pinEl = document.getElementById('pin');
        const pin = pinEl ? pinEl.value : '';

        if (!currentJobId || !currentEmployeeId || !currentPay) {
          alert('Missing job context. Refresh the page and try again.');
          return;
        }

        const payload = {
          jobId: currentJobId,
          to: currentEmployeeId,
          amount: currentPay,
          reason: `Completed ${currentTitle || ''}`,
          pin: pin
        };

        // hide popup while processing
        popup.style.display = 'none';

        try {
          const res = await fetch('/transfer/complete', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data && data.success) {
            // success: reload to reflect changes
            window.location.reload();
          } else {
            alert('Transfer failed: ' + (data && data.message ? data.message : 'unknown'));
          }
        } catch (err) {
          console.error('Transfer error', err);
          alert('Transfer error');
        }
      });
    })();
  </script>
</body>

</html>